workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "terraform"'

stages:
  # - plan
  - sync


# plan:
#   tags:
#     - terraform
#   stage: plan
#   image: registry.argondeploy.ru/infra/tools:terraform
#   script:
#   - terraform init
#   - terraform plan --var-file groups.tfvars --var-file projects.tfvars

sync-prod:
  tags:
    - gcp-prod
  stage: sync
  image: registry.argondeploy.ru/infra/tools:terraform
  script:
  - export GOOGLE_CREDENTIALS=$GCP_ARGONDEPLOY_KEY
  - cd prod
  - terraform init
  - terraform apply -auto-approve --var-file access.tfvars

sync-demo:
  tags:
    - gcp-demo
  stage: sync
  image: registry.argondeploy.ru/infra/tools:terraform
  script:
  - export GOOGLE_CREDENTIALS=$GCP_ARGONDEPLOY_KEY
  - cd demo
  - terraform init
  - terraform apply -auto-approve --var-file access.tfvars